TODO: use mutexes instead of global statics